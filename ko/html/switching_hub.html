<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ko">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>스위칭 허브 &#8212; Ryubook 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="top" title="Ryubook 1.0 documentation" href="index.html" />
    <link rel="next" title="트래픽 모니터" href="traffic_monitor.html" />
    <link rel="prev" title="역자 머리말" href="preface_translation.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>탐색</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="전체 색인"
             accesskey="I">색인</a></li>
        <li class="right" >
          <a href="traffic_monitor.html" title="트래픽 모니터"
             accesskey="N">다음</a> |</li>
        <li class="right" >
          <a href="preface_translation.html" title="역자 머리말"
             accesskey="P">이전</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ryubook 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ch-switching-hub">
<span id="id1"></span><h1>스위칭 허브<a class="headerlink" href="#ch-switching-hub" title="제목 주소">¶</a></h1>
<p>이 장에서는 간단한 스위칭 허브 구현을 주제로 Ryu를 사용한 응용 프로그램을
구현하는 방법을 설명하고 있습니다.</p>
<div class="section" id="id2">
<h2>스위칭 허브<a class="headerlink" href="#id2" title="제목 주소">¶</a></h2>
<p>스위칭 허브는 다양한 기능들을 갖고 있습니다만, 여기에서는
다음과 같은 간단한 기능을 가진 스위칭 허브의 구현을 살펴 보고자 합니다.</p>
<ul class="simple">
<li>포트에 연결되어 있는 호스트의 MAC 주소를 학습하고 MAC 주소 테이블을
유지하기</li>
<li>이미 학습된 호스트에 대한 패킷을 수신하면 호스트에 연결된 포트로 전송</li>
<li>알 수 없는 호스트에 대한 패킷을 수신하면, 플러딩(Flooding)</li>
</ul>
<p>이러한 스위치를 Ryu를 사용하여 구현해 봅시다.</p>
</div>
<div class="section" id="openflow">
<h2>OpenFlow 의한 스위칭 허브<a class="headerlink" href="#openflow" title="제목 주소">¶</a></h2>
<p>OpenFlow 스위치는 Ryu와 같은 OpenFlow 컨트롤러의 지시를 받고,
다음과 같은 것들을 수행할 수 있습니다.</p>
<ul class="simple">
<li>수신된 패킷의 주소를 재작성(rewrite)하거나 지정된 포트쪽으로부터 전송</li>
<li>받은 패킷을 컨트롤러에 전송 (Packet-In)</li>
<li>컨트롤러에 의해 전달된 (forwarded) 패킷을 특정 포트쪽으로부터 전송 (Packet-Out)</li>
</ul>
<p>이러한 기능들을 결합하여 스위칭 허브를 만들 수 있습니다.</p>
<p>우선, Packet-In 기능을 이용하여 MAC 주소를 학습할 필요가 있습니다.
컨트롤러는 Packet-In 기능을 이용하여 스위치로부터 패킷을 받을 수가 있습니다.
스위치는 받은 패킷을 분석하고 연결되어 있는
포트에 대한 호스트의 MAC 주소 및 정보를 학습할 수 있습니다.</p>
<p>학습 후에는 받은 패킷을 전송합니다.
스위치는 패킷의 목적지 MAC 주소가 학습된 호스트에 속해있는지 아닌지를
찾아봅니다.
검색 결과 여부에 따라 스위치는 다음과 같은 작업을 수행합니다.</p>
<ul class="simple">
<li>학습된 호스트인 경우 ... Packet-Out 기능으로 연결된 포트쪽으로 패킷을 전송</li>
<li>알 수 없는 호스트인 경우 ... Packet-Out 기능으로 패킷을 플러딩</li>
</ul>
<p>이러한 동작을 그림과 함께 단계별로 설명합니다.</p>
<ol class="arabic">
<li><p class="first">초기 상태</p>
<blockquote>
<div><blockquote>
<div><p>플로우 테이블이 비어있는 초기 상태입니다.</p>
<p>포트 1에 호스트 A, 포트 4에 호스트 B, 포트 3에 호스트 C가 연결되어 있다고
가정합니다.</p>
</div></blockquote>
<img alt="_images/fig19.png" class="align-center" src="_images/fig19.png" />
</div></blockquote>
</li>
<li><p class="first">호스트 A → 호스트 B</p>
<blockquote>
<div><blockquote>
<div><p>호스트 A에서 호스트 B로 패킷이 전송되면 Packet-In 메시지가 전송되고
호스트 A의 MAC 주소가 포트 1에 학습됩니다. 호스트 B의 포트는 아직 알지
못하기 때문에 패킷은 플러딩되고 따라서 해당 패킷은 호스트 B와
호스트 C에서 수신됩니다.</p>
</div></blockquote>
<img alt="_images/fig26.png" class="align-center" src="_images/fig26.png" />
<p>Packet-In:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ow">in</span><span class="o">-</span><span class="n">port</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">eth</span><span class="o">-</span><span class="n">dst</span><span class="p">:</span> <span class="n">호스트B</span>
<span class="n">eth</span><span class="o">-</span><span class="n">src</span><span class="p">:</span> <span class="n">호스트A</span>
</pre></div>
</div>
<p>Packet-Out:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">action</span><span class="p">:</span> <span class="n">OUTPUT</span><span class="p">:</span><span class="n">Flooding</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">호스트B→호스트A</p>
<blockquote>
<div><blockquote>
<div><p>호스트 B에서 호스트 A로 패킷이 리턴되면 플로우 테이블에 항목을 추가하고
또한 패킷은 포트 1에 전송됩니다. 따라서 호스트 C는 이 패킷을
수신하지 않습니다.</p>
</div></blockquote>
<img alt="_images/fig36.png" class="align-center" src="_images/fig36.png" />
<p>Packet-In:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ow">in</span><span class="o">-</span><span class="n">port</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">eth</span><span class="o">-</span><span class="n">dst</span><span class="p">:</span> <span class="n">호스트A</span>
<span class="n">eth</span><span class="o">-</span><span class="n">src</span><span class="p">:</span> <span class="n">호스트B</span>
</pre></div>
</div>
<p>Packet-Out:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">action</span><span class="p">:</span> <span class="n">OUTPUT</span><span class="p">:</span><span class="n">포트1</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">호스트A→호스트B</p>
<blockquote>
<div><blockquote>
<div><p>또한, 호스트 A에서 호스트 B로 패킷이 전송되면 플로우 테이블에
항목을 추가하고 또한 패킷은 포트 4에 전송됩니다.</p>
</div></blockquote>
<img alt="_images/fig45.png" class="align-center" src="_images/fig45.png" />
<p>Packet-In:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="ow">in</span><span class="o">-</span><span class="n">port</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">eth</span><span class="o">-</span><span class="n">dst</span><span class="p">:</span> <span class="n">호스트B</span>
<span class="n">eth</span><span class="o">-</span><span class="n">src</span><span class="p">:</span> <span class="n">호스트A</span>
</pre></div>
</div>
<p>Packet-Out:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">action</span><span class="p">:</span> <span class="n">OUTPUT</span><span class="p">:</span><span class="n">호스트4</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ol>
<p>이제, Ryu를 사용하여 구현된 스위칭 허브 소스 코드를 살펴 보겠습니다.</p>
</div>
<div class="section" id="ryu">
<h2>Ryu를 사용한 스위칭 허브 구현<a class="headerlink" href="#ryu" title="제목 주소">¶</a></h2>
<p>스위칭 허브에 대한 소스 코드는 Ryu 소스 트리에 있습니다.</p>
<blockquote>
<div>ryu/app/simple_switch_13.py</div></blockquote>
<p>OpenFlow 버전에 따라 그 밖에도 simple_switch.py (OpenFlow 1.0),
simple_switch_12.py (OpenFlow 1.2)이 있지만, 여기에서는 OpenFlow 1.3을 지원하는
구현을 살펴 보겠습니다.</p>
<p>짧은 소스 코드이므로, 전체를 여기에 게재합니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ryu.base</span> <span class="k">import</span> <span class="n">app_manager</span>
<span class="kn">from</span> <span class="nn">ryu.controller</span> <span class="k">import</span> <span class="n">ofp_event</span>
<span class="kn">from</span> <span class="nn">ryu.controller.handler</span> <span class="k">import</span> <span class="n">CONFIG_DISPATCHER</span><span class="p">,</span> <span class="n">MAIN_DISPATCHER</span>
<span class="kn">from</span> <span class="nn">ryu.controller.handler</span> <span class="k">import</span> <span class="n">set_ev_cls</span>
<span class="kn">from</span> <span class="nn">ryu.ofproto</span> <span class="k">import</span> <span class="n">ofproto_v1_3</span>
<span class="kn">from</span> <span class="nn">ryu.lib.packet</span> <span class="k">import</span> <span class="n">packet</span>
<span class="kn">from</span> <span class="nn">ryu.lib.packet</span> <span class="k">import</span> <span class="n">ethernet</span>


<span class="k">class</span> <span class="nc">SimpleSwitch13</span><span class="p">(</span><span class="n">app_manager</span><span class="o">.</span><span class="n">RyuApp</span><span class="p">):</span>
    <span class="n">OFP_VERSIONS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ofproto_v1_3</span><span class="o">.</span><span class="n">OFP_VERSION</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleSwitch13</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@set_ev_cls</span><span class="p">(</span><span class="n">ofp_event</span><span class="o">.</span><span class="n">EventOFPSwitchFeatures</span><span class="p">,</span> <span class="n">CONFIG_DISPATCHER</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">switch_features_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
        <span class="n">datapath</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">datapath</span>
        <span class="n">ofproto</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto_parser</span>

        <span class="c1"># install table-miss flow entry</span>
        <span class="c1">#</span>
        <span class="c1"># We specify NO BUFFER to max_len of the output action due to</span>
        <span class="c1"># OVS bug. At this moment, if we specify a lesser number, e.g.,</span>
        <span class="c1"># 128, OVS will send Packet-In with invalid buffer_id and</span>
        <span class="c1"># truncated packet data. In that case, we cannot output packets</span>
        <span class="c1"># correctly.</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPMatch</span><span class="p">()</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">OFPActionOutput</span><span class="p">(</span><span class="n">ofproto</span><span class="o">.</span><span class="n">OFPP_CONTROLLER</span><span class="p">,</span>
                                          <span class="n">ofproto</span><span class="o">.</span><span class="n">OFPCML_NO_BUFFER</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flow</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
        <span class="n">ofproto</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto_parser</span>

        <span class="n">inst</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">OFPInstructionActions</span><span class="p">(</span><span class="n">ofproto</span><span class="o">.</span><span class="n">OFPIT_APPLY_ACTIONS</span><span class="p">,</span>
                                             <span class="n">actions</span><span class="p">)]</span>

        <span class="n">mod</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPFlowMod</span><span class="p">(</span><span class="n">datapath</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                                <span class="n">match</span><span class="o">=</span><span class="n">match</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="n">inst</span><span class="p">)</span>
        <span class="n">datapath</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>

    <span class="nd">@set_ev_cls</span><span class="p">(</span><span class="n">ofp_event</span><span class="o">.</span><span class="n">EventOFPPacketIn</span><span class="p">,</span> <span class="n">MAIN_DISPATCHER</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_packet_in_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">msg</span>
        <span class="n">datapath</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">datapath</span>
        <span class="n">ofproto</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto_parser</span>
        <span class="n">in_port</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">match</span><span class="p">[</span><span class="s1">&#39;in_port&#39;</span><span class="p">]</span>

        <span class="n">pkt</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">Packet</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="n">eth</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_protocols</span><span class="p">(</span><span class="n">ethernet</span><span class="o">.</span><span class="n">ethernet</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">dst</span> <span class="o">=</span> <span class="n">eth</span><span class="o">.</span><span class="n">dst</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">eth</span><span class="o">.</span><span class="n">src</span>

        <span class="n">dpid</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dpid</span><span class="p">,</span> <span class="p">{})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;packet in </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpid</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">in_port</span><span class="p">)</span>

        <span class="c1"># learn a mac address to avoid FLOOD next time.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="p">[</span><span class="n">dpid</span><span class="p">][</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_port</span>

        <span class="k">if</span> <span class="n">dst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="p">[</span><span class="n">dpid</span><span class="p">]:</span>
            <span class="n">out_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="p">[</span><span class="n">dpid</span><span class="p">][</span><span class="n">dst</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_port</span> <span class="o">=</span> <span class="n">ofproto</span><span class="o">.</span><span class="n">OFPP_FLOOD</span>

        <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">OFPActionOutput</span><span class="p">(</span><span class="n">out_port</span><span class="p">)]</span>

        <span class="c1"># install a flow to avoid packet_in next time</span>
        <span class="k">if</span> <span class="n">out_port</span> <span class="o">!=</span> <span class="n">ofproto</span><span class="o">.</span><span class="n">OFPP_FLOOD</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPMatch</span><span class="p">(</span><span class="n">in_port</span><span class="o">=</span><span class="n">in_port</span><span class="p">,</span> <span class="n">eth_dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_flow</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">buffer_id</span> <span class="o">==</span> <span class="n">ofproto</span><span class="o">.</span><span class="n">OFP_NO_BUFFER</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPPacketOut</span><span class="p">(</span><span class="n">datapath</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span> <span class="n">buffer_id</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">buffer_id</span><span class="p">,</span>
                                  <span class="n">in_port</span><span class="o">=</span><span class="n">in_port</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">datapath</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<p>그러면, 각각의 구현 내용을 살펴 보겠습니다.</p>
<div class="section" id="id3">
<h3>클래스의 정의 및 초기화<a class="headerlink" href="#id3" title="제목 주소">¶</a></h3>
<p>Ryu 응용 프로그램으로 구현하기 위해 ryu.base.app_manager.RyuApp을
상속합니다. 또한 OpenFlow 1.3을 사용하기 때문에 <code class="docutils literal"><span class="pre">OFP_VERSIONS</span></code>
에 OpenFlow 1.3 버전을 지정합니다.</p>
<p>또한 MAC 주소 테이블에 해당하는 mac_to_port를 정의합니다.</p>
<p>OpenFlow 프로토콜은 OpenFlow 스위치와 컨트롤러가 통신을 위해
필요한 핸드 셰이크 등의 몇 가지 단계가 정의되어 있습니다. 그러나, Ryu의
프레임워크가 이러한 단계들을 다루기에, Ryu 응용 프로그램에서는 이러한 것들을
신경쓰지 않아도 됩니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">SimpleSwitch13</span><span class="p">(</span><span class="n">app_manager</span><span class="o">.</span><span class="n">RyuApp</span><span class="p">):</span>
    <span class="n">OFP_VERSIONS</span> <span class="o">=</span> <span class="p">[</span><span class="n">ofproto_v1_3</span><span class="o">.</span><span class="n">OFP_VERSION</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SimpleSwitch13</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>이벤트 처리기<a class="headerlink" href="#id4" title="제목 주소">¶</a></h3>
<p>Ryu에서, OpenFlow 메시지를 수신하면 해당 메시지에 대응하는 이벤트가 생성
됩니다. Ryu 응용 프로그램은 수신하고자 하는 메시지에 대응하는 이벤트
처리기를 구현합니다.</p>
<p>이벤트 처리기는 인수 처리를 위해 이벤트 객체를 갖는 함수를 정의하고
한정(decorate)을 위해 <code class="docutils literal"><span class="pre">ryu.controller.handler.set_ev_cls</span></code> 한정자를 사용합니다.</p>
<p>set_ev_cls는 수신하는 메시지를 지원하는 이벤트 클래스와 인수에 대한
OpenFlow 스위치의 상태를 지정합니다.</p>
<p>이벤트 클래스 이름은 <code class="docutils literal"><span class="pre">ryu.controller.ofp_event.EventOFP</span></code> + &lt;OpenFlow
메시지 이름&gt; 입니다. 예를 들어, Packet-In 메시지의 경우
<code class="docutils literal"><span class="pre">EventOFPPacketIn</span></code> 입니다.
자세한 내용은 Ryu 문서 <a class="reference external" href="http://ryu.readthedocs.org/en/latest/">API 레퍼런스</a> 를 참조하십시오.
상태에 대해서는 다음 중 하나 또는 리스트로 지정합니다.</p>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">정의</th>
<th class="head">설명</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ryu.controller.handler.HANDSHAKE_DISPATCHER</td>
<td>HELLO 메시지 교환</td>
</tr>
<tr class="row-odd"><td>ryu.controller.handler.CONFIG_DISPATCHER</td>
<td>SwitchFeatures 메시지의 수신</td>
</tr>
<tr class="row-even"><td>ryu.controller.handler.MAIN_DISPATCHER</td>
<td>표준 상태</td>
</tr>
<tr class="row-odd"><td>ryu.controller.handler.DEAD_DISPATCHER</td>
<td>연결 절단</td>
</tr>
</tbody>
</table>
<div class="section" id="table-miss">
<h4>Table-miss 플로우 항목 추가<a class="headerlink" href="#table-miss" title="제목 주소">¶</a></h4>
<p>OpenFlow 스위치와의 핸드 셰이크가 완료된 후, Table-miss 플로우 항목(entry)이
플로우 테이블에 추가되고 Packet-In 메시지를 수신할 준비를 합니다.</p>
<p>구체적으로는 Switch Features (Features Reply) 메시지를 수신하자마자
Table-miss 플로우 항목을 추가합니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="nd">@set_ev_cls</span><span class="p">(</span><span class="n">ofp_event</span><span class="o">.</span><span class="n">EventOFPSwitchFeatures</span><span class="p">,</span> <span class="n">CONFIG_DISPATCHER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">switch_features_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">datapath</span>
    <span class="n">ofproto</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto_parser</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">ev.msg</span></code> 에는 이벤트에 해당하는 OpenFlow 메시지 클래스의 인스턴스가
저장되어 있습니다. 이 경우에는
<code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_3_parser.OFPSwitchFeatures</span></code> 입니다.</p>
<p><code class="docutils literal"><span class="pre">msg.datapath</span></code> 에는 이 메시지를 발행한 OpenFlow 스위치에 해당하는
<code class="docutils literal"><span class="pre">ryu.controller.controller.Datapath</span></code> 클래스의 인스턴스가 저장되어 있습니다.</p>
<p>Datapath 클래스는 OpenFlow 스위치와의 실제 통신 처리 및 수신 메시지에 대응하는
이벤트 발행 등의 중요한 작업을 수행하고 있습니다.</p>
<p>Ryu 응용 프로그램에서 사용되는 주요 특성은 다음과 같습니다.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="82%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">속성이름</th>
<th class="head">설명</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>id</td>
<td>연결된 OpenFlow 스위치 ID (데이터 경로 ID)입니다.</td>
</tr>
<tr class="row-odd"><td>ofproto</td>
<td><p class="first">사용하는 OpenFlow 버전에 대응하는 ofproto 모듈을
보여줍니다. 현재는 다음 중 하나입니다.</p>
<p><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_0</span></code></p>
<p><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_2</span></code></p>
<p><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_3</span></code></p>
<p class="last"><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_4</span></code></p>
</td>
</tr>
<tr class="row-even"><td>ofproto_parser</td>
<td><p class="first">ofproto와 마찬가지로 ofproto_parser 모듈을 보여줍니다.
현재는 다음 중 하나입니다.</p>
<p><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_0_parser</span></code></p>
<p><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_2_parser</span></code></p>
<p><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_3_parser</span></code></p>
<p class="last"><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_4_parser</span></code></p>
</td>
</tr>
</tbody>
</table>
<p>Ryu 응용 프로그램에서 사용하는 Datapath 클래스의 주요 메서드는 다음과 같습니다.</p>
<p>send_msg(msg)</p>
<blockquote>
<div>OpenFlow 메시지를 보냅니다.
msg는 보내는 OpenFlow 메시지에 대응하는
<code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_parser.MsgBase</span></code> 의 서브 클래스입니다.</div></blockquote>
<p>스위칭 허브는 받은 Switch Features 메시지 자체는 특별히
사용하지 않습니다. Table-miss 플로우 항목을 추가하는 타이밍을 위한
이벤트로 다루고 있습니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">switch_features_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># install table-miss flow entry</span>
    <span class="c1">#</span>
    <span class="c1"># We specify NO BUFFER to max_len of the output action due to</span>
    <span class="c1"># OVS bug. At this moment, if we specify a lesser number, e.g.,</span>
    <span class="c1"># 128, OVS will send Packet-In with invalid buffer_id and</span>
    <span class="c1"># truncated packet data. In that case, we cannot output packets</span>
    <span class="c1"># correctly.</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPMatch</span><span class="p">()</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">OFPActionOutput</span><span class="p">(</span><span class="n">ofproto</span><span class="o">.</span><span class="n">OFPP_CONTROLLER</span><span class="p">,</span>
                                      <span class="n">ofproto</span><span class="o">.</span><span class="n">OFPCML_NO_BUFFER</span><span class="p">)]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_flow</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>
</pre></div>
</div>
<p>Table-miss 플로우 항목은 우선 순위가 최저(0)이고, 모든 패킷에 매치되는
항목입니다. 이 항목의 명령(instruction)에는 컨트롤러 포트로의 출력을
출력 액션으로 지정하여, 들어오는 패킷이 모든 정상(normal) 플로우
항목과 일치하지 않으면, Packet-In을 생성할 수 있습니다.</p>
<div class="admonition note">
<p class="first admonition-title">주석</p>
<p class="last">2014 년 1 월 현재 Open vSwitch는 OpenFlow 1.3의 지원이 불완전이며,
OpenFlow 1.3 이전과 마찬가지로 기본적으로 Packet-In이 생성됩니다. 또한
Table-miss 플로우 항목이 현재는 지원되지 않고 정상(normal) 플로우 항목으로
취급됩니다.</p>
</div>
<p>모든 패킷에 매치시키기 위해 빈 Match을 생성합니다. Match는
<code class="docutils literal"><span class="pre">OFPMatch</span></code> 클래스로 표현됩니다.</p>
<p>그 다음, 컨트롤러 포트로 전송하는 OUTPUT 액션 클래스 (
<code class="docutils literal"><span class="pre">OFPActionOutput</span></code>)의 인스턴스를 생성합니다.
컨트롤러가 output 대상으로 지정되고 max_len에는
<code class="docutils literal"><span class="pre">OFPCML_NO_BUFFER</span></code> 을 지정하여 모든 패킷들이 컨트롤러로 전송되도록 합니다.</p>
<div class="admonition note">
<p class="first admonition-title">주석</p>
<p class="last">컨트롤러는 패킷의 시작 부분(Ethernet 헤더 분)만을 전송
하고 나머지는 스위치 버퍼에 두는 것이 효율성 측면에서 바람직
하지만 Open vSwitch 버그를 해결하기 위해 여기에 전체 패킷을
전송합니다. 이 버그는 Open vSwitch 2.1.0에서 수정되었습니다.</p>
</div>
<p>마지막으로, 우선 순위 0(가장 낮음)을 지정하여 <code class="docutils literal"><span class="pre">add_flow()</span></code> 메서드를 실행하여 Flow Mod
메시지를 보냅니다. add_flow() 메서드의 내용에 대해서는 뒤에서 설명하고자 합니다.</p>
</div>
<div class="section" id="packet-in">
<h4>Packet-in 메시지<a class="headerlink" href="#packet-in" title="제목 주소">¶</a></h4>
<p>알 수 없는 목적지를 가진 수신 패킷을 허용하기 위해 Packet-In 이벤트 처리기를 만듭니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="nd">@set_ev_cls</span><span class="p">(</span><span class="n">ofp_event</span><span class="o">.</span><span class="n">EventOFPPacketIn</span><span class="p">,</span> <span class="n">MAIN_DISPATCHER</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_packet_in_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">msg</span>
    <span class="n">datapath</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">datapath</span>
    <span class="n">ofproto</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto_parser</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
<p>자주 사용되는 OFPPacketIn 클래스의 속성은 다음과 같은 것들이 있습니다.</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">속성이름</th>
<th class="head">설명</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>match</td>
<td><code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_3_parser.OFPMatch</span></code> 클래스의 인스턴스
에서 들어오는 패킷의 메타 정보가 설정되어 있습니다.</td>
</tr>
<tr class="row-odd"><td>data</td>
<td>수신 패킷 자체를 나타내는 이진 데이터입니다.</td>
</tr>
<tr class="row-even"><td>total_len</td>
<td>수신 패킷의 데이터 길이입니다.</td>
</tr>
<tr class="row-odd"><td>buffer_id</td>
<td>수신 패킷이 OpenFlow 스위치에서 버퍼처리 되는 경우
해당 ID가 표시됩니다. 버퍼처리 되지 않는 경우
<code class="docutils literal"><span class="pre">ryu.ofproto.ofproto_v1_3.OFP_NO_BUFFER</span></code> 가 설정됩니다.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="mac">
<h4>MAC 주소 테이블 업데이트<a class="headerlink" href="#mac" title="제목 주소">¶</a></h4>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_packet_in_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">in_port</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">match</span><span class="p">[</span><span class="s1">&#39;in_port&#39;</span><span class="p">]</span>

    <span class="n">pkt</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">Packet</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="n">eth</span> <span class="o">=</span> <span class="n">pkt</span><span class="o">.</span><span class="n">get_protocols</span><span class="p">(</span><span class="n">ethernet</span><span class="o">.</span><span class="n">ethernet</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">dst</span> <span class="o">=</span> <span class="n">eth</span><span class="o">.</span><span class="n">dst</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">eth</span><span class="o">.</span><span class="n">src</span>

    <span class="n">dpid</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">dpid</span><span class="p">,</span> <span class="p">{})</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;packet in </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpid</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">in_port</span><span class="p">)</span>

    <span class="c1"># learn a mac address to avoid FLOOD next time.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="p">[</span><span class="n">dpid</span><span class="p">][</span><span class="n">src</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_port</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
<p>OFPPacketIn 클래스의 match에서 수신 포트(<code class="docutils literal"><span class="pre">in_port</span></code>)를 가져옵니다.
대상 MAC 주소와 원본 MAC 주소는 Ryu 패킷 라이브러리를 사용하여
수신 패킷의 Ethernet 헤더에서 얻어집니다.</p>
<p>가져온 원본 MAC 주소와 수신 포트 번호를 기반으로 MAC 주소 테이블을 업데이트합니다.</p>
<p>여러 OpenFlow 스위치와의 연결에 대응하기 위해 MAC 주소 테이블은 OpenFlow
스위치마다 관리하도록 되어 있습니다. OpenFlow 스위치를 식별하는 데이터 경로 ID
를 이용하고 있습니다.</p>
</div>
<div class="section" id="id5">
<h4>대상 포트 판정<a class="headerlink" href="#id5" title="제목 주소">¶</a></h4>
<p>대상 MAC 주소가 MAC 주소 테이블에 존재하는 경우 대응되는 포트 번호가
사용됩니다. 발견되지 않으면 플러딩(<code class="docutils literal"><span class="pre">OFPP_FLOOD</span></code>)를 출력 포트에 지정하는
OUTPUT 액션 클래스의 인스턴스를 생성합니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_packet_in_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="k">if</span> <span class="n">dst</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="p">[</span><span class="n">dpid</span><span class="p">]:</span>
        <span class="n">out_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mac_to_port</span><span class="p">[</span><span class="n">dpid</span><span class="p">][</span><span class="n">dst</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_port</span> <span class="o">=</span> <span class="n">ofproto</span><span class="o">.</span><span class="n">OFPP_FLOOD</span>

    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">OFPActionOutput</span><span class="p">(</span><span class="n">out_port</span><span class="p">)]</span>

    <span class="c1"># install a flow to avoid packet_in next time</span>
    <span class="k">if</span> <span class="n">out_port</span> <span class="o">!=</span> <span class="n">ofproto</span><span class="o">.</span><span class="n">OFPP_FLOOD</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPMatch</span><span class="p">(</span><span class="n">in_port</span><span class="o">=</span><span class="n">in_port</span><span class="p">,</span> <span class="n">eth_dst</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_flow</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
<p>대상 MAC 주소가 있으면, OpenFlow 스위치의 플로우 테이블에
항목을 추가합니다.</p>
<p>Table-miss 플로우 항목의 추가와 마찬가지로 매치와 액션을 지정하고
add_flow()를 실행하여 플로우 항목을 추가합니다.</p>
<p>Table-miss 플로우 항목과 달리, 이번에는 매치 조건을 설정합니다.
이번 스위칭 허브의 구현에서는 수신 포트 (in_port)와 대상 MAC 주소
(eth_dst)를 지정합니다. 예를 들어, 「포트 1에서 수신하고 호스트 B로 향하는」
패킷이 대상이 됩니다.</p>
<p>이번 플로우 항목은 우선 순위에 1을 지정합니다. 값이 클
수록 우선 순위가 높아지므로 여기에 추가하는 플로우 항목은 Table-miss 플로우
항목보다 먼저 평가됩니다.</p>
<p>위의 작업을 포함하여 정리하면 다음과 유사한 항목을 플로우 테이블
에 추가합니다.</p>
<blockquote>
<div>포트 1에서 수신한 호스트 B로 전달되는 (대상 MAC 주소가 B) 패킷을
포트 4에 전송하기</div></blockquote>
<div class="admonition hint">
<p class="first admonition-title">힌트</p>
<p class="last">OpenFlow에서 NORMAL 포트는 논리적인 출력 포트가 옵션으로 규정하고
출력 포트에 NORMAL을 지정하면 스위치의 L2/L3 기능을 사용하라고
패킷을 처리할 수 있습니다. 즉, 모든 패킷을 NORMAL
포트에 출력하도록 지시하는 것만으로, 스위칭 허브 역할을 하는 것처럼
할 수 있지만, 여기에서는 각각의 처리를 OpenFlow를 사용하여 수행하는 것으로 합니다.</p>
</div>
</div>
<div class="section" id="id6">
<h4>플로우 항목의 추가 처리<a class="headerlink" href="#id6" title="제목 주소">¶</a></h4>
<p>Packet-In 처리기에서의 처리가 아직 끝나지 않지만 여기서 일단 플로우 항목을
추가하는 메서드 쪽을 살펴 보겠습니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">priority</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
    <span class="n">ofproto</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">datapath</span><span class="o">.</span><span class="n">ofproto_parser</span>

    <span class="n">inst</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">OFPInstructionActions</span><span class="p">(</span><span class="n">ofproto</span><span class="o">.</span><span class="n">OFPIT_APPLY_ACTIONS</span><span class="p">,</span>
                                         <span class="n">actions</span><span class="p">)]</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
<p>플로우 항목에는 대상 패킷의 조건을 나타내는 매치와 패킷에
대한 작업을 나타내는 인스트럭션, 우선 순위, 유효 시간 등을
설정합니다.</p>
<p>스위칭 허브의 구현은 인스트럭션에 Apply Actions를 사용하여
지정된 액션을 즉시 적용하도록 설정합니다.</p>
<p>마지막으로, Flow Mod 메시지를 발행하여 플로우 테이블에 항목을 추가합니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datapath</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">actions</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">mod</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPFlowMod</span><span class="p">(</span><span class="n">datapath</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                            <span class="n">match</span><span class="o">=</span><span class="n">match</span><span class="p">,</span> <span class="n">instructions</span><span class="o">=</span><span class="n">inst</span><span class="p">)</span>
    <span class="n">datapath</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</pre></div>
</div>
<p>Flow Mod 메시지에 대응하는 클래스는 <code class="docutils literal"><span class="pre">OFPFlowMod</span></code> 클래스입니다. OFPFlowMod
클래스의 인스턴스를 생성하여 Datapath.send_msg() 메서드를 사용해 OpenFlow
스위치에 메시지를 보냅니다.</p>
<p>OFPFlowMod 클래스의 생성자에는 많은 인수가 있습니다만, 일반적으로
대부분의 경우 기본값을 그대로 하면됩니다. 괄호 안은 기본값입니다.</p>
<p>datapath</p>
<blockquote>
<div>플로우 테이블을 조작하는 대상 OpenFlow 스위치에 해당하는 Datapath
클래스의 인스턴스입니다. 일반적으로 Packet-In 메시지 등의 처리기
에 전달되는 이벤트에서 가져온 것입니다.</div></blockquote>
<p>cookie (0)</p>
<blockquote>
<div>컨트롤러에 지정하는 선택적 값으로 항목을 업데이트 또는 삭제할 때
필터 조건으로 사용할 수 있습니다. 패킷 처리에는 사용되지 않습니다.</div></blockquote>
<p>cookie_mask (0)</p>
<blockquote>
<div>항목의 업데이트 또는 삭제하는 경우 0이 아닌 값을 지정하면 항목의
cookie 값을 사용하는 동작 대상 항목의 필터로 사용됩니다.</div></blockquote>
<p>table_id (0)</p>
<blockquote>
<div>동작 대상의 플로우 테이블의 테이블 ID를 지정합니다.</div></blockquote>
<p>command (ofproto_v1_3.OFPFC_ADD)</p>
<blockquote>
<div><p>어떤 작업을 할 것인지를 지정합니다.</p>
<table border="1" class="docutils">
<colgroup>
<col width="30%" />
<col width="70%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">값</th>
<th class="head">설명</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>OFPFC_ADD</td>
<td>새로운 플로우 항목을 추가합니다</td>
</tr>
<tr class="row-odd"><td>OFPFC_MODIFY</td>
<td>플로우 항목을 업데이트합니다</td>
</tr>
<tr class="row-even"><td>OFPFC_MODIFY_STRICT</td>
<td>엄격하게 일치하는 플로우 항목을 업데이트합니다</td>
</tr>
<tr class="row-odd"><td>OFPFC_DELETE</td>
<td>플로우 항목을 삭제합니다</td>
</tr>
<tr class="row-even"><td>OFPFC_DELETE_STRICT</td>
<td>엄격하게 일치하는 플로우 항목을 삭제합니다</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>idle_timeout (0)</p>
<blockquote>
<div><p>해당 항목의 유효 기간을 초 단위로 지정합니다. 항목이 참조되지 않고
idle_timeout에서 지정된 시간을 초과하면 항목이 제거됩니다.
항목이 참조 될 때 경과 시간은 리셋됩니다.</p>
<p>항목이 삭제되면 Flow Removed 메시지가 컨트롤러에 알려
있습니다.</p>
</div></blockquote>
<p>hard_timeout (0)</p>
<blockquote>
<div><p>해당 항목의 유효 기간을 초 단위로 지정합니다. idle_timeout과 달리,
hard_timeout은 항목이 참조되더라도 경과 시간은 리셋되지 않습니다.
즉, 항목의 참조 여부에 관계없이 지정된 시간이 경과하면
항목이 삭제됩니다.</p>
<p>idle_timeout과 마찬가지로 항목이 삭제되면 Flow Removed 메시지가
보내집니다.</p>
</div></blockquote>
<p>priority (0)</p>
<blockquote>
<div>해당 항목의 우선 순위를 지정합니다.
값이 클수록 우선 순위가 높습니다.</div></blockquote>
<p>buffer_id (ofproto_v1_3.OFP_NO_BUFFER)</p>
<blockquote>
<div><p>OpenFlow 스위치에서 버퍼된 패킷의 버퍼 ID를 지정합니다.
버퍼 ID는 Packet-In 메시지로 통지되고, 지정하면
OFPP_TABLE을 출력 포트에 지정된 Packet-Out 메시지와 Flow Mod 메시지
두 메시지를 보낸 것처럼 처리됩니다.
command가 OFPFC_DELETE 또는 OFPFC_DELETE_STRICT의 경우는 무시됩니다.</p>
<p>버퍼 ID를 지정하지 않으면, <code class="docutils literal"><span class="pre">OFP_NO_BUFFER</span></code> 을 설정합니다.</p>
</div></blockquote>
<p>out_port (0)</p>
<blockquote>
<div><p>OFPFC_DELETE 또는 OFPFC_DELETE_STRICT의 경우 대상 항목을
출력 포트 필터링합니다. OFPFC_ADD, OFPFC_MODIFY, OFPFC_MODIFY_STRICT
의 경우는 무시됩니다.</p>
<p>출력 포트의 필터를 해제하려면 <code class="docutils literal"><span class="pre">OFPP_ANY</span></code> 을 지정합니다.</p>
</div></blockquote>
<p>out_group (0)</p>
<blockquote>
<div><p>out_port와 마찬가지로 출력 그룹에서 필터링합니다.</p>
<p>해제하려면 <code class="docutils literal"><span class="pre">OFPG_ANY</span></code> 을 지정합니다.</p>
</div></blockquote>
<p>flags (0)</p>
<blockquote>
<div><p>다음 플래그의 조합을 지정할 수 있습니다.</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">값</th>
<th class="head">설명</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>OFPFF_SEND_FLOW_REM</td>
<td>FLOW_REM이 항목이 삭제될 때 컨트롤러에 Flow
Removed 메시지를 발행합니다.</td>
</tr>
<tr class="row-odd"><td>OFPFF_CHECK_OVERLAP</td>
<td>OFPFC_ADD의 경우 중복 항목의 검사를 수행
합니다. 중복된 항목이 있는 경우에는 Flow Mod가 손실
되고 오류가 반환됩니다.</td>
</tr>
<tr class="row-even"><td>OFPFF_RESET_COUNTS</td>
<td>해당 항목의 패킷과 바이트 카운터를
재설정합니다.</td>
</tr>
<tr class="row-odd"><td>OFPFF_NO_PKT_COUNTS</td>
<td>이 항목의 패킷 카운터를 해제합니다.</td>
</tr>
<tr class="row-even"><td>OFPFF_NO_BYT_COUNTS</td>
<td>이 항목에 대한 바이트 카운터를 해제합니다.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>match (None)</p>
<blockquote>
<div>Match를 지정합니다.</div></blockquote>
<p>instructions ([])</p>
<blockquote>
<div>명령어의 목록을 지정합니다.</div></blockquote>
</div>
<div class="section" id="id7">
<h4>패킷 전송<a class="headerlink" href="#id7" title="제목 주소">¶</a></h4>
<p>Packet-In 처리기로 돌아가 마지막 처리 단계를 설명합니다.</p>
<p>대상 MAC 주소를 MAC 주소 테이블에서 발견하는 여부와 관계없이 최종
적으로 Packet-Out 메시지를 생성하여 수신 패킷을 전송합니다.</p>
<div class="sourcecode highlight-default"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_packet_in_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ev</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">buffer_id</span> <span class="o">==</span> <span class="n">ofproto</span><span class="o">.</span><span class="n">OFP_NO_BUFFER</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">OFPPacketOut</span><span class="p">(</span><span class="n">datapath</span><span class="o">=</span><span class="n">datapath</span><span class="p">,</span> <span class="n">buffer_id</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">buffer_id</span><span class="p">,</span>
                              <span class="n">in_port</span><span class="o">=</span><span class="n">in_port</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="n">actions</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">datapath</span><span class="o">.</span><span class="n">send_msg</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
<p>Packet-Out 메시지에 대응하는 클래스는 <code class="docutils literal"><span class="pre">OFPPacketOut</span></code> 클래스입니다.</p>
<p>OFPPacketOut 생성자의 인수는 다음과 같이되어 있습니다.</p>
<p>datapath</p>
<blockquote>
<div>OpenFlow 스위치에 해당하는 Datapath 클래스의 인스턴스를 지정합니다.</div></blockquote>
<p>buffer_id</p>
<blockquote>
<div>OpenFlow 스위치에서 버퍼 된 패킷 버퍼 ID를 지정합니다.
버퍼를 사용하지 않으면, <code class="docutils literal"><span class="pre">OFP_NO_BUFFER</span></code> 을 지정합니다.</div></blockquote>
<p>in_port</p>
<blockquote>
<div>패킷을 수신 한 포트를 지정합니다. 수신 패킷이 아닌 경우
<code class="docutils literal"><span class="pre">OFPP_CONTROLLER</span></code> 를 지정합니다.</div></blockquote>
<p>actions</p>
<blockquote>
<div>작업 목록을 지정합니다.</div></blockquote>
<p>data</p>
<blockquote>
<div>패킷의 이진 데이터를 지정합니다. buffer_id에 <code class="docutils literal"><span class="pre">OFP_NO_BUFFER</span></code>
가 지정된 경우에 사용됩니다. OpenFlow 스위치 버퍼를 사용하는 경
우 생략합니다.</div></blockquote>
<p>스위칭 허브의 구현은 buffer_id에 Packet-In 메시지 buffer_id를
지정합니다. Packet-In 메시지 내 buffer_id가 무효 인 경우,
들어오는 Packet-In 패킷을 data로 지정하여 패킷을 전송합니다.</p>
<p>이제 스위칭 허브 소스 코드의 설명이 끝났습니다.
다음으로 스위칭 허브를 실행하여 실제 동작을 확인합니다.</p>
</div>
</div>
</div>
<div class="section" id="id8">
<h2>Ryu 응용 프로그램 실행<a class="headerlink" href="#id8" title="제목 주소">¶</a></h2>
<p>스위칭 허브의 실행을 위해 OpenFlow 스위치는 Open vSwitch 실행
환경으로 mininet을 사용합니다.</p>
<p>Ryu의 OpenFlow Tutorial VM 이미지가 포함되어 있으므로,이 VM 이미지
를 이용하면 실험 환경을 쉽게 준비할 수 있습니다.</p>
<p>VM 이미지</p>
<blockquote>
<div><p><a class="reference external" href="http://sourceforge.net/projects/ryu/files/vmimages/OpenFlowTutorial/">http://sourceforge.net/projects/ryu/files/vmimages/OpenFlowTutorial/</a></p>
<p>OpenFlow_Tutorial_Ryu3.2.ova (약1.4GB)</p>
</div></blockquote>
<p>관련 문서 (Wiki 페이지)</p>
<blockquote>
<div><a class="reference external" href="https://github.com/osrg/ryu/wiki/OpenFlow_Tutorial">https://github.com/osrg/ryu/wiki/OpenFlow_Tutorial</a></div></blockquote>
<p>문서에 있는 VM 이미지는 Open vSwitch와 Ryu의 버전이 오래 되었기 때문에
주의하시기 바랍니다.</p>
<p>이 VM 이미지를 사용하지 않고, 스스로 환경을 구축하는 것 또한 당연히 가능합니다.
스스로 환경을 구축하고자 하는 경우, 참고로, VM 이미지에서 사용하는 각 소프트웨어 버전은 다음과 같습니다.</p>
<dl class="docutils">
<dt>Mininet VM 버전 2.0.0</dt>
<dd><a class="reference external" href="http://mininet.org/download/">http://mininet.org/download/</a></dd>
<dt>Open vSwitch 버전 1.11.0</dt>
<dd><a class="reference external" href="http://openvswitch.org/download/">http://openvswitch.org/download/</a></dd>
<dt>Ryu 버전 3.2</dt>
<dd><p class="first"><a class="reference external" href="https://github.com/osrg/ryu/">https://github.com/osrg/ryu/</a></p>
<blockquote class="last">
<div><div class="console highlight-default"><div class="highlight"><pre><span></span>$ sudo pip install ryu
</pre></div>
</div>
</div></blockquote>
</dd>
</dl>
<p>여기에서는 Ryu 용 OpenFlow Tutorial의 VM 이미지를 사용합니다.</p>
<div class="section" id="mininet">
<h3>Mininet 실행<a class="headerlink" href="#mininet" title="제목 주소">¶</a></h3>
<p>mininet에서 xterm을 시작하기 위해 X를 사용할 수 있는 환경이 필요합니다.</p>
<p>여기에서는 OpenFlow Tutorial VM을 사용하므로,
ssh에서 X11 Forwarding을 사용하여 로그인하십시오.</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>$ ssh -X ryu@&lt;VM 주소&gt;
</pre></div>
</div>
</div></blockquote>
<p>사용자 이름은 <code class="docutils literal"><span class="pre">ryu</span></code> 이고, 암호는 <code class="docutils literal"><span class="pre">ryu</span></code> 입니다.</p>
<p>로그인 후, <code class="docutils literal"><span class="pre">mn</span></code> 명령으로 Mininet 환경을 시작합니다.</p>
<p>구축 환경은 호스트 3 대, 스위치 하나의 간단한 구성입니다.</p>
<p>mn 명령의 매개 변수는 다음과 같습니다.</p>
<table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="15%" />
<col width="66%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">매개변수</th>
<th class="head">값</th>
<th class="head">설명</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>topo</td>
<td>single,3</td>
<td>스위치 1 개, 호스트가 3 개인 토폴로지</td>
</tr>
<tr class="row-odd"><td>mac</td>
<td>없음</td>
<td>자동으로 호스트의 MAC 주소를 설정함</td>
</tr>
<tr class="row-even"><td>switch</td>
<td>ovsk</td>
<td>Open vSwitch를 사용</td>
</tr>
<tr class="row-odd"><td>controller</td>
<td>remote</td>
<td>외부 OpenFlow 컨트롤러 사용</td>
</tr>
<tr class="row-even"><td>x</td>
<td>없음</td>
<td>xterm을 시작</td>
</tr>
</tbody>
</table>
<p>실행 예는 다음과 같습니다.</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span>$ sudo mn --topo single,3 --mac --switch ovsk --controller remote -x
*** Creating network
*** Adding controller
Unable to contact the remote controller at 127.0.0.1:6633
*** Adding hosts:
h1 h2 h3
*** Adding switches:
s1
*** Adding links:
(h1, s1) (h2, s1) (h3, s1)
*** Configuring hosts
h1 h2 h3
*** Running terms on localhost:10.0
*** Starting controller
*** Starting 1 switches
s1
*** Starting CLI:
mininet&gt;
</pre></div>
</div>
<p>실행하면 데스크탑 PC에서 5개의 xterm이 시작됩니다.
각 xterm은 호스트 1~3, 스위치, 그리고 컨트롤러에 대응합니다.</p>
<p>스위치에 대한 xterm에서 명령을 실행하여 사용하는 OpenFlow 버전을
설정합니다. 윈도우 제목이 「switch : s1 (root)」인 xterm으로
스위치용 xterm입니다.</p>
<p>우선 Open vSwitch의 상태를 확인합니다.</p>
<p>switch: s1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># ovs-vsctl show</span>
<span class="n">fdec0957</span><span class="o">-</span><span class="mi">12</span><span class="n">b6</span><span class="o">-</span><span class="mi">4417</span><span class="o">-</span><span class="mi">9</span><span class="n">d02</span><span class="o">-</span><span class="mi">847654</span><span class="n">e9cc1f</span>
<span class="n">Bridge</span> <span class="s2">&quot;s1&quot;</span>
    <span class="n">Controller</span> <span class="s2">&quot;ptcp:6634&quot;</span>
    <span class="n">Controller</span> <span class="s2">&quot;tcp:127.0.0.1:6633&quot;</span>
    <span class="n">fail_mode</span><span class="p">:</span> <span class="n">secure</span>
    <span class="n">Port</span> <span class="s2">&quot;s1-eth3&quot;</span>
        <span class="n">Interface</span> <span class="s2">&quot;s1-eth3&quot;</span>
    <span class="n">Port</span> <span class="s2">&quot;s1-eth2&quot;</span>
        <span class="n">Interface</span> <span class="s2">&quot;s1-eth2&quot;</span>
    <span class="n">Port</span> <span class="s2">&quot;s1-eth1&quot;</span>
        <span class="n">Interface</span> <span class="s2">&quot;s1-eth1&quot;</span>
    <span class="n">Port</span> <span class="s2">&quot;s1&quot;</span>
        <span class="n">Interface</span> <span class="s2">&quot;s1&quot;</span>
            <span class="nb">type</span><span class="p">:</span> <span class="n">internal</span>
<span class="n">ovs_version</span><span class="p">:</span> <span class="s2">&quot;1.11.0&quot;</span>
<span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># ovs-dpctl show</span>
<span class="n">system</span><span class="nd">@ovs</span><span class="o">-</span><span class="n">system</span><span class="p">:</span>
        <span class="n">lookups</span><span class="p">:</span> <span class="n">hit</span><span class="p">:</span><span class="mi">14</span> <span class="n">missed</span><span class="p">:</span><span class="mi">14</span> <span class="n">lost</span><span class="p">:</span><span class="mi">0</span>
        <span class="n">flows</span><span class="p">:</span> <span class="mi">0</span>
        <span class="n">port</span> <span class="mi">0</span><span class="p">:</span> <span class="n">ovs</span><span class="o">-</span><span class="n">system</span> <span class="p">(</span><span class="n">internal</span><span class="p">)</span>
        <span class="n">port</span> <span class="mi">1</span><span class="p">:</span> <span class="n">s1</span> <span class="p">(</span><span class="n">internal</span><span class="p">)</span>
        <span class="n">port</span> <span class="mi">2</span><span class="p">:</span> <span class="n">s1</span><span class="o">-</span><span class="n">eth1</span>
        <span class="n">port</span> <span class="mi">3</span><span class="p">:</span> <span class="n">s1</span><span class="o">-</span><span class="n">eth2</span>
        <span class="n">port</span> <span class="mi">4</span><span class="p">:</span> <span class="n">s1</span><span class="o">-</span><span class="n">eth3</span>
<span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
<p>스위치 (브리지) <em>s1</em> 이 생성되었고, 호스트에 해당 포트가
3개 추가되어 있습니다.</p>
<p>다음 OpenFlow 버전을 1.3으로 설정합니다.</p>
<p>switch: s1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># ovs-vsctl set Bridge s1 protocols=OpenFlow13</span>
<span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
<p>플로우 테이블을 확인해 봅시다.</p>
<p>switch: s1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># ovs-ofctl -O OpenFlow13 dump-flows s1</span>
<span class="n">OFPST_FLOW</span> <span class="n">reply</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2</span><span class="p">):</span>
<span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
<p>ovs-ofctl 명령 실행시, 옵션으로 사용하는 OpenFlow 버전을
지정해야 합니다. 기본값은 <em>OpenFlow10</em> 입니다.</p>
</div>
<div class="section" id="id9">
<h3>스위칭 허브 실행<a class="headerlink" href="#id9" title="제목 주소">¶</a></h3>
<p>모든 준비가 완료되었으므로, Ryu 응용 프로그램을 실행합니다.</p>
<p>윈도우 제목이 「controller : c0 (root)」인 xterm에서
다음 명령을 실행합니다.</p>
<p>controller: c0:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># ryu-manager --verbose ryu.app.simple_switch_13</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">simple_switch_13</span>
<span class="n">loading</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">simple_switch_13</span>
<span class="n">instantiating</span> <span class="n">app</span> <span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_handler</span>
<span class="n">BRICK</span> <span class="n">SimpleSwitch13</span>
  <span class="n">CONSUMES</span> <span class="n">EventOFPSwitchFeatures</span>
  <span class="n">CONSUMES</span> <span class="n">EventOFPPacketIn</span>
<span class="n">BRICK</span> <span class="n">ofp_event</span>
  <span class="n">PROVIDES</span> <span class="n">EventOFPSwitchFeatures</span> <span class="n">TO</span> <span class="p">{</span><span class="s1">&#39;SimpleSwitch13&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;config&#39;</span><span class="p">])}</span>
  <span class="n">PROVIDES</span> <span class="n">EventOFPPacketIn</span> <span class="n">TO</span> <span class="p">{</span><span class="s1">&#39;SimpleSwitch13&#39;</span><span class="p">:</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;main&#39;</span><span class="p">])}</span>
  <span class="n">CONSUMES</span> <span class="n">EventOFPErrorMsg</span>
  <span class="n">CONSUMES</span> <span class="n">EventOFPHello</span>
  <span class="n">CONSUMES</span> <span class="n">EventOFPEchoRequest</span>
  <span class="n">CONSUMES</span> <span class="n">EventOFPPortDescStatsReply</span>
  <span class="n">CONSUMES</span> <span class="n">EventOFPSwitchFeatures</span>
<span class="n">connected</span> <span class="n">socket</span><span class="p">:</span><span class="o">&lt;</span><span class="n">eventlet</span><span class="o">.</span><span class="n">greenio</span><span class="o">.</span><span class="n">GreenSocket</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2e2c050</span><span class="o">&gt;</span> <span class="n">address</span><span class="p">:(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">53937</span><span class="p">)</span>
<span class="n">hello</span> <span class="n">ev</span> <span class="o">&lt;</span><span class="n">ryu</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">ofp_event</span><span class="o">.</span><span class="n">EventOFPHello</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x2e2a550</span><span class="o">&gt;</span>
<span class="n">move</span> <span class="n">onto</span> <span class="n">config</span> <span class="n">mode</span>
<span class="n">EVENT</span> <span class="n">ofp_event</span><span class="o">-&gt;</span><span class="n">SimpleSwitch13</span> <span class="n">EventOFPSwitchFeatures</span>
<span class="n">switch</span> <span class="n">features</span> <span class="n">ev</span> <span class="n">version</span><span class="p">:</span> <span class="mh">0x4</span> <span class="n">msg_type</span> <span class="mh">0x6</span> <span class="n">xid</span> <span class="mh">0xff9ad15b</span> <span class="n">OFPSwitchFeatures</span><span class="p">(</span><span class="n">auxiliary_id</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">capabilities</span><span class="o">=</span><span class="mi">71</span><span class="p">,</span><span class="n">datapath_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_buffers</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span><span class="n">n_tables</span><span class="o">=</span><span class="mi">254</span><span class="p">)</span>
<span class="n">move</span> <span class="n">onto</span> <span class="n">main</span> <span class="n">mode</span>
</pre></div>
</div>
<p>OVS와의 연결에 시간이 걸리는 경우도 있지만, 잠시 기다리면 다음과 같이</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">connected</span> <span class="n">socket</span><span class="p">:</span><span class="o">&lt;....</span>
<span class="n">hello</span> <span class="n">ev</span> <span class="o">...</span>
<span class="o">...</span>
<span class="n">move</span> <span class="n">onto</span> <span class="n">main</span> <span class="n">mode</span>
</pre></div>
</div>
<p>로 표시됩니다.</p>
<p>이제 OVS와 연결되었고, 핸드쉐이크가 이루어져 Table-miss 플로우 항목이
추가되었고, 스위칭 허브는 Packet-In을 기다리는 상태입니다.</p>
<p>Table-miss 플로우 항목이 추가되어 있는지 확인합니다.</p>
<p>switch: s1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># ovs-ofctl -O openflow13 dump-flows s1</span>
<span class="n">OFPST_FLOW</span> <span class="n">reply</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2</span><span class="p">):</span>
 <span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">105.975</span><span class="n">s</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_packets</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">65535</span>
<span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
<p>우선 순위가 0으로 매치가 없는 상태이고, 액션에 CONTROLLER 전송 데이터 크기로 65535
(0xffff = OFPCML_NO_BUFFER)가 지정되어 있습니다.</p>
</div>
<div class="section" id="id10">
<h3>동작 확인<a class="headerlink" href="#id10" title="제목 주소">¶</a></h3>
<p>호스트 1에서 호스트 2로 ping을 실행합니다.</p>
<ol class="arabic">
<li><p class="first">ARP request</p>
<blockquote>
<div><p>이 시점에서 호스트 1은 호스트 2의 MAC 주소를 모르기 때문에 ICMP echo
request 이전에 ARP request를 브로드 캐스팅됩니다.
이 브로드 캐스트 패킷은 호스트 2 및 호스트 3에서 수신합니다.</p>
</div></blockquote>
</li>
<li><p class="first">ARP reply</p>
<blockquote>
<div><p>호스트 2가 ARP에 응답하여 호스트 1에 ARP reply를 반환합니다.</p>
</div></blockquote>
</li>
<li><p class="first">ICMP echo request</p>
<blockquote>
<div><p>이제 호스트 1 호스트 2의 MAC 주소를 알고 있으므로, echo request를
호스트 2에 보냅니다.</p>
</div></blockquote>
</li>
<li><p class="first">ICMP echo reply</p>
<blockquote>
<div><p>호스트 2는 호스트 1의 MAC 주소를 이미 알고 있기 때문에, echo reply를
호스트 1에 반환합니다.</p>
</div></blockquote>
</li>
</ol>
<p>이렇게 통신이 이루어지는 것입니다.</p>
<p>ping 명령을 실행하기 전에 각 호스트에 어떤 패킷을 수신했는지 확인하기 위해
tcpdump 명령을 실행합니다.</p>
<p>host: h1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># tcpdump -en -i h1-eth0</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="ow">or</span> <span class="o">-</span><span class="n">vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">h1</span><span class="o">-</span><span class="n">eth0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="mi">65535</span> <span class="nb">bytes</span>
</pre></div>
</div>
<p>host: h2:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># tcpdump -en -i h2-eth0</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="ow">or</span> <span class="o">-</span><span class="n">vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">h2</span><span class="o">-</span><span class="n">eth0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="mi">65535</span> <span class="nb">bytes</span>
</pre></div>
</div>
<p>host: h3:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># tcpdump -en -i h3-eth0</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="ow">or</span> <span class="o">-</span><span class="n">vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">h3</span><span class="o">-</span><span class="n">eth0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="mi">65535</span> <span class="nb">bytes</span>
</pre></div>
</div>
<p>그럼, 먼저 mn 명령을 실행한 콘솔에서 다음 명령을 실행하여
호스트 1에서 호스트 2로 ping을 수행합니다.</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">mininet</span><span class="o">&gt;</span> <span class="n">h1</span> <span class="n">ping</span> <span class="o">-</span><span class="n">c1</span> <span class="n">h2</span>
<span class="n">PING</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="p">(</span><span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span><span class="p">)</span> <span class="mi">56</span><span class="p">(</span><span class="mi">84</span><span class="p">)</span> <span class="nb">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="o">.</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span><span class="p">:</span> <span class="n">icmp_req</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">97.5</span> <span class="n">ms</span>

<span class="o">---</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="o">---</span>
<span class="mi">1</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="mi">1</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span><span class="p">,</span> <span class="n">time</span> <span class="mi">0</span><span class="n">ms</span>
<span class="n">rtt</span> <span class="nb">min</span><span class="o">/</span><span class="n">avg</span><span class="o">/</span><span class="nb">max</span><span class="o">/</span><span class="n">mdev</span> <span class="o">=</span> <span class="mf">97.594</span><span class="o">/</span><span class="mf">97.594</span><span class="o">/</span><span class="mf">97.594</span><span class="o">/</span><span class="mf">0.000</span> <span class="n">ms</span>
<span class="n">mininet</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>ICMP echo reply가 정상적으로 반환됩니다.</p>
<p>우선, 플로우 테이블을 확인합니다.</p>
<p>switch: s1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># ovs-ofctl -O openflow13 dump-flows s1</span>
<span class="n">OFPST_FLOW</span> <span class="n">reply</span> <span class="p">(</span><span class="n">OF1</span><span class="o">.</span><span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="n">xid</span><span class="o">=</span><span class="mh">0x2</span><span class="p">):</span>
 <span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">417.838</span><span class="n">s</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_packets</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="mi">182</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">0</span> <span class="n">actions</span><span class="o">=</span><span class="n">CONTROLLER</span><span class="p">:</span><span class="mi">65535</span>
 <span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">48.444</span><span class="n">s</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_packets</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="n">actions</span><span class="o">=</span><span class="n">output</span><span class="p">:</span><span class="mi">1</span>
 <span class="n">cookie</span><span class="o">=</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mf">48.402</span><span class="n">s</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_packets</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_bytes</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">priority</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">in_port</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dl_dst</span><span class="o">=</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="n">actions</span><span class="o">=</span><span class="n">output</span><span class="p">:</span><span class="mi">2</span>
<span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1">#</span>
</pre></div>
</div>
<p>Table-miss 플로우 항목 이외에 우선 순위가 1인 플로우 항목이 2 개 등록되어
있습니다.</p>
<ol class="arabic simple">
<li>수신 포트 (in_port):2, MAC 수신 주소(dl_dst):호스트 1 →
동작(actions):포트1로 전송</li>
<li>수신 포트 (in_port):1, MAC 수신 주소(dl_dst):호스트 2 →
동작(actions):포트2로 전송</li>
</ol>
<p>(1) 항목은 2 번 reference되고 (n_packets), (2) 항목은 1 번 reference됩니다.
(1)은 호스트 2에서 호스트 1로의 통신이므로, ARP reply 및 ICMP echo reply 두 가지
에 일치해야 합니다.
(2)는 호스트 1에서 호스트 2로의 통신에서, ARP request가 브로드캐스트되므로
이는 ICMP echo request에 의한 것입니다.</p>
<p>그럼 simple_switch_13 로그 결과를 살펴 봅시다.</p>
<p>controller: c0:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">EVENT</span> <span class="n">ofp_event</span><span class="o">-&gt;</span><span class="n">SimpleSwitch13</span> <span class="n">EventOFPPacketIn</span>
<span class="n">packet</span> <span class="ow">in</span> <span class="mi">1</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span> <span class="mi">1</span>
<span class="n">EVENT</span> <span class="n">ofp_event</span><span class="o">-&gt;</span><span class="n">SimpleSwitch13</span> <span class="n">EventOFPPacketIn</span>
<span class="n">packet</span> <span class="ow">in</span> <span class="mi">1</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="mi">2</span>
<span class="n">EVENT</span> <span class="n">ofp_event</span><span class="o">-&gt;</span><span class="n">SimpleSwitch13</span> <span class="n">EventOFPPacketIn</span>
<span class="n">packet</span> <span class="ow">in</span> <span class="mi">1</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="mi">1</span>
</pre></div>
</div>
<p>첫 번째 Packet-In은 호스트 1이 발행한 ARP request이고, 브로드캐스트이므로
플로우 항목에 등록되지 않고 Packet-Out 만 발행됩니다.</p>
<p>두 번째는 호스트 2에서 반환된 ARP reply에서 목적지 MAC 주소가 호스트 1이고
따라서 위의 플로우 항목 (1)이 등록됩니다.</p>
<p>세 번째는 호스트 1에서 호스트 2로 전송 된 ICMP echo request에서 플로우 항목
(2)이 등록됩니다.</p>
<p>호스트 2에서 호스트 1에 반환 된 ICMP echo reply는 등록된 플로우 항목 (1)에
일치하기 때문에 Packet-In은 발행되지 않고 호스트 1에 전송됩니다.</p>
<p>마지막으로 각 호스트에서 실행한 tcpdump의 출력 결과를 살펴봅시다.</p>
<p>host: h1:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># tcpdump -en -i h1-eth0</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="ow">or</span> <span class="o">-</span><span class="n">vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">h1</span><span class="o">-</span><span class="n">eth0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="mi">65535</span> <span class="nb">bytes</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.625473</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="o">&gt;</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">ARP</span> <span class="p">(</span><span class="mh">0x0806</span><span class="p">),</span> <span class="n">length</span> <span class="mi">42</span><span class="p">:</span> <span class="n">Request</span> <span class="n">who</span><span class="o">-</span><span class="n">has</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">tell</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">28</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.678698</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="o">&gt;</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">ARP</span> <span class="p">(</span><span class="mh">0x0806</span><span class="p">),</span> <span class="n">length</span> <span class="mi">42</span><span class="p">:</span> <span class="n">Reply</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="ow">is</span><span class="o">-</span><span class="n">at</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span><span class="p">,</span> <span class="n">length</span> <span class="mi">28</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.678731</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="o">&gt;</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">IPv4</span> <span class="p">(</span><span class="mh">0x0800</span><span class="p">),</span> <span class="n">length</span> <span class="mi">98</span><span class="p">:</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">3940</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">64</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.722973</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="o">&gt;</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">IPv4</span> <span class="p">(</span><span class="mh">0x0800</span><span class="p">),</span> <span class="n">length</span> <span class="mi">98</span><span class="p">:</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">reply</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">3940</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">64</span>
</pre></div>
</div>
<p>호스트 1에서 먼저 ARP request가 브로드캐스트되고 있어, 계속 호스트 2에서
반환된 ARP reply를 받고 있습니다.
그런 다음, 호스트 1는 ICMP echo request를 발행하고, 호스트 2에서 반환된 ICMP echo reply를 수신합니다.</p>
<p>host: h2:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># tcpdump -en -i h2-eth0</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="ow">or</span> <span class="o">-</span><span class="n">vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">h2</span><span class="o">-</span><span class="n">eth0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="mi">65535</span> <span class="nb">bytes</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.637987</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="o">&gt;</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">ARP</span> <span class="p">(</span><span class="mh">0x0806</span><span class="p">),</span> <span class="n">length</span> <span class="mi">42</span><span class="p">:</span> <span class="n">Request</span> <span class="n">who</span><span class="o">-</span><span class="n">has</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">tell</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">28</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.638059</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="o">&gt;</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">ARP</span> <span class="p">(</span><span class="mh">0x0806</span><span class="p">),</span> <span class="n">length</span> <span class="mi">42</span><span class="p">:</span> <span class="n">Reply</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="ow">is</span><span class="o">-</span><span class="n">at</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span><span class="p">,</span> <span class="n">length</span> <span class="mi">28</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.722601</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="o">&gt;</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">IPv4</span> <span class="p">(</span><span class="mh">0x0800</span><span class="p">),</span> <span class="n">length</span> <span class="mi">98</span><span class="p">:</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">3940</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">64</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.722747</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span> <span class="o">&gt;</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">IPv4</span> <span class="p">(</span><span class="mh">0x0800</span><span class="p">),</span> <span class="n">length</span> <span class="mi">98</span><span class="p">:</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span> <span class="n">ICMP</span> <span class="n">echo</span> <span class="n">reply</span><span class="p">,</span> <span class="nb">id</span> <span class="mi">3940</span><span class="p">,</span> <span class="n">seq</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">64</span>
</pre></div>
</div>
<p>호스트 2에서 호스트 1이 발행한 ARP request를 수신하고, 호스트 1에 ARP reply를
반환합니다. 그런 다음, 호스트 1에서 ICMP echo request를 수신하고 호스트 1에
echo reply를 반환합니다.</p>
<p>host: h3:</p>
<div class="console highlight-default"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ryu</span><span class="o">-</span><span class="n">vm</span><span class="p">:</span><span class="o">~</span><span class="c1"># tcpdump -en -i h3-eth0</span>
<span class="n">tcpdump</span><span class="p">:</span> <span class="n">verbose</span> <span class="n">output</span> <span class="n">suppressed</span><span class="p">,</span> <span class="n">use</span> <span class="o">-</span><span class="n">v</span> <span class="ow">or</span> <span class="o">-</span><span class="n">vv</span> <span class="k">for</span> <span class="n">full</span> <span class="n">protocol</span> <span class="n">decode</span>
<span class="n">listening</span> <span class="n">on</span> <span class="n">h3</span><span class="o">-</span><span class="n">eth0</span><span class="p">,</span> <span class="n">link</span><span class="o">-</span><span class="nb">type</span> <span class="n">EN10MB</span> <span class="p">(</span><span class="n">Ethernet</span><span class="p">),</span> <span class="n">capture</span> <span class="n">size</span> <span class="mi">65535</span> <span class="nb">bytes</span>
<span class="mi">20</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">04.637954</span> <span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span> <span class="o">&gt;</span> <span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">:</span><span class="n">ff</span><span class="p">,</span> <span class="n">ethertype</span> <span class="n">ARP</span> <span class="p">(</span><span class="mh">0x0806</span><span class="p">),</span> <span class="n">length</span> <span class="mi">42</span><span class="p">:</span> <span class="n">Request</span> <span class="n">who</span><span class="o">-</span><span class="n">has</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.2</span> <span class="n">tell</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">length</span> <span class="mi">28</span>
</pre></div>
</div>
<p>호스트 3은 먼저 호스트 1의 브로드캐스팅 된 ARP request 만 수신
하고 있습니다.</p>
</div>
</div>
<div class="section" id="id11">
<h2>정리<a class="headerlink" href="#id11" title="제목 주소">¶</a></h2>
<p>이 장에서는 간단한 스위칭 허브 구현을 주제로 Ryu 응용 프로그램 구현에 대해
기본적인 절차와 OpenFlow에 따른 OpenFlow 스위치의 간단한 제어 방법을
설명하였습니다.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">목차</a></h3>
  <ul>
<li><a class="reference internal" href="#">스위칭 허브</a><ul>
<li><a class="reference internal" href="#id2">스위칭 허브</a></li>
<li><a class="reference internal" href="#openflow">OpenFlow 의한 스위칭 허브</a></li>
<li><a class="reference internal" href="#ryu">Ryu를 사용한 스위칭 허브 구현</a><ul>
<li><a class="reference internal" href="#id3">클래스의 정의 및 초기화</a></li>
<li><a class="reference internal" href="#id4">이벤트 처리기</a><ul>
<li><a class="reference internal" href="#table-miss">Table-miss 플로우 항목 추가</a></li>
<li><a class="reference internal" href="#packet-in">Packet-in 메시지</a></li>
<li><a class="reference internal" href="#mac">MAC 주소 테이블 업데이트</a></li>
<li><a class="reference internal" href="#id5">대상 포트 판정</a></li>
<li><a class="reference internal" href="#id6">플로우 항목의 추가 처리</a></li>
<li><a class="reference internal" href="#id7">패킷 전송</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#id8">Ryu 응용 프로그램 실행</a><ul>
<li><a class="reference internal" href="#mininet">Mininet 실행</a></li>
<li><a class="reference internal" href="#id9">스위칭 허브 실행</a></li>
<li><a class="reference internal" href="#id10">동작 확인</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">정리</a></li>
</ul>
</li>
</ul>

  <h4>이전 항목</h4>
  <p class="topless"><a href="preface_translation.html"
                        title="이전 장">역자 머리말</a></p>
  <h4>다음 항목</h4>
  <p class="topless"><a href="traffic_monitor.html"
                        title="다음 장">트래픽 모니터</a></p>
  <div role="note" aria-label="source link">
    <h3>현재 문서</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/switching_hub.txt"
            rel="nofollow">소스 코드를 보려면</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>빠른 검색</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="바로 가기" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>탐색</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="전체 색인"
             >색인</a></li>
        <li class="right" >
          <a href="traffic_monitor.html" title="트래픽 모니터"
             >다음</a> |</li>
        <li class="right" >
          <a href="preface_translation.html" title="역자 머리말"
             >이전</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ryubook 1.0 documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, RYU project team.
    </div>
  </body>
</html>